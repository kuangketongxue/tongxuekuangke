<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>æ¯æ—¥ä¿¡æ¯æ‘„å…¥æµç¨‹ | ç‹‚å®¢ç©ºé—´</title>
    <meta name="description" content="æ¯æ—¥ä¿¡æ¯æ‘„å…¥æµç¨‹ - 30åˆ†é’Ÿçœ‹å®Œä¼˜è´¨ä¿¡æ¯æºçš„æ˜¨æ—¥æ›´æ–°">
    <meta name="keywords" content="ä¿¡æ¯æ‘„å…¥,æµç¨‹,æ•ˆç‡,æ¯æ—¥ä¾‹è¡Œ,å­¦ä¹ ">
    <meta name="author" content="ç‹‚å®¢">
    <meta name="robots" content="index,follow">
    <meta name="theme-color" content="#000000">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âœ¦</text></svg>">
    <!-- DNSé¢„è§£æ -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <!-- é¢„è¿æ¥ -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <!-- å­—ä½“ä¼˜åŒ–åŠ è½½ -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@600;700;900&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@600;700;900&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet"></noscript>
    <style>
        :root{
            --primary-gold:#d4af37;
            --primary-black:#000;
            --primary-white:#fff;
            --bg-primary:#000;
            --text-primary:#fff;
            --text-secondary:#e0e0e0;
            --text-gold:#d4af37;
            --border-gold:rgba(212,175,55,.3);
            --transition:.4s cubic-bezier(.4,0,.2,1);
            --font-serif:'Noto Serif SC',serif;
            --font-sans:'Noto Sans SC',sans-serif
        }
        *{margin:0;padding:0;box-sizing:border-box}
        html{font-size:16px;scroll-behavior:smooth;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
        body{
            font-family:var(--font-sans);
            background:var(--bg-primary);
            color:var(--text-primary);
            line-height:1.8;
            overflow-x:hidden;
            font-weight:500;
            text-shadow:0 1px 2px rgba(0,0,0,0.8);
        }
        .hidden{display:none !important;}

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.95);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:9999;
            transition:opacity .5s ease;
        }
        .loading-overlay.hidden{
            opacity:0;
            pointer-events:none;
        }
        .loader{
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:20px;
        }
        .spinner{
            width:60px;
            height:60px;
            border:4px solid rgba(212,175,55,.2);
            border-top-color:var(--primary-gold);
            border-radius:50%;
            animation:spin 1s linear infinite;
        }
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-text{
            color:var(--text-gold);
            font-size:1.1rem;
            font-weight:600;
            letter-spacing:.1em;
        }
        /* é”™è¯¯æç¤º */
        .error-message{
            position:fixed;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            background:rgba(255,77,79,.15);
            border:2px solid #ff4d4f;
            border-radius:12px;
            padding:32px 48px;
            text-align:center;
            z-index:9998;
            backdrop-filter:blur(20px);
            max-width:500px;
            display:none;
        }
        .error-message.show{display:block}
        .error-icon{font-size:3rem;margin-bottom:16px}
        .error-title{
            font-size:1.5rem;
            font-weight:700;
            color:#ff4d4f;
            margin-bottom:12px;
        }
        .error-desc{
            color:var(--text-secondary);
            line-height:1.6;
            margin-bottom:20px;
        }
        .error-btn{
            padding:12px 24px;
            background:rgba(212,175,55,.2);
            border:2px solid var(--primary-gold);
            border-radius:6px;
            color:var(--text-gold);
            font-weight:700;
            cursor:pointer;
            transition:var(--transition);
        }
        .error-btn:hover{
            background:rgba(212,175,55,.35);
            transform:translateY(-2px);
        }

        .hero-background{position:fixed;top:0;left:0;width:100%;height:100vh;z-index:0;overflow:hidden;will-change:transform}
        .hero-background::before{
            content:'';
            position:absolute;
            inset:0;
            background:url('image/00294682dfcd997e226623d058d51aab.png') center/cover no-repeat fixed;
            filter:brightness(1.5) contrast(1.3);
            will-change:transform;
            animation:zoom 20s ease-in-out infinite alternate
        }
        @keyframes zoom{to{transform:scale(1.05)}}
        .hero-background::after{
            content:'';
            position:absolute;
            inset:0;
            background:linear-gradient(180deg,rgba(0,0,0,.25) 0%,rgba(0,0,0,.65) 100%);
            backdrop-filter:blur(.5px)
        }

        .main-wrapper{position:relative;z-index:1;padding-top:48px;min-height:100vh}
        .container{max-width:1000px;margin:0 auto;padding:0 24px}

        /* è¿”å›æŒ‰é’® */
        .back-button{
            position:fixed;
            top:70px;
            left:24px;
            z-index:101;
            display:flex;
            align-items:center;
            gap:8px;
            padding:12px 20px;
            background:rgba(0,0,0,.75);
            border:1px solid var(--border-gold);
            border-radius:4px;
            color:var(--text-gold);
            text-decoration:none;
            font-size:.9rem;
            font-weight:600;
            backdrop-filter:blur(20px);
            transition:var(--transition);
            cursor:pointer;
            text-shadow:0 2px 4px rgba(0,0,0,0.9);
        }
        .back-button:hover{
            background:rgba(212,175,55,.25);
            border-color:var(--primary-gold);
            transform:translateX(-4px);
            box-shadow:0 4px 16px rgba(212,175,55,.4);
        }
        .back-button svg{width:16px;height:16px;transition:transform .3s ease}
        .back-button:hover svg{transform:translateX(-2px)}

        /* é¡¶éƒ¨å£°æ˜ */
        .top-notice{
            position:fixed;
            top:0;left:0;right:0;
            background:rgba(212,175,55,.18);
            border-bottom:1px solid var(--border-gold);
            backdrop-filter:blur(20px);
            z-index:100;
            padding:12px 24px;
            text-align:center;
            font-size:.9rem;
            font-weight:600;
            color:var(--text-secondary);
            text-shadow:0 1px 3px rgba(0,0,0,0.9);
        }
        .notice-close{
            background:transparent;border:1px solid var(--border-gold);
            color:var(--text-gold);width:24px;height:24px;border-radius:50%;
            cursor:pointer;transition:var(--transition);font-weight:700;
        }

        /* é¡µå¤´ */
        .page-header{padding:120px 0 24px;text-align:center}
        .page-title{
            font-family:var(--font-serif);
            font-size:clamp(2rem,5vw,3rem);
            font-weight:900;
            color:var(--primary-gold);
            letter-spacing:.05em;
            margin-bottom:12px;
            background:linear-gradient(135deg,var(--primary-gold),#f4e4b8,var(--primary-gold));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
            animation:glow 3s ease-in-out infinite alternate;
            filter:drop-shadow(0 2px 6px rgba(212,175,55,0.6));
        }
        @keyframes glow{to{filter:brightness(1.2) drop-shadow(0 0 30px rgba(212,175,55,.6)) drop-shadow(0 2px 6px rgba(212,175,55,0.6))}}
        .page-subtitle{
            color:var(--text-secondary);
            font-weight:600;
            letter-spacing:.15em;
            font-size:1.05rem;
            text-shadow:0 2px 4px rgba(0,0,0,0.9);
        }

        /* ç»Ÿè®¡ + è¿›åº¦æ¡ + æ§ä»¶ */
        .intake-stats{
            margin:24px auto 8px;
            display:flex;gap:16px;justify-content:center;flex-wrap:wrap;
            color:#f0f0f0;font-size:1rem;font-weight:600;
        }
        .stat-chip{
            display:inline-flex;align-items:center;gap:8px;
            padding:10px 16px;border:1px solid var(--border-gold);
            border-radius:999px;background:rgba(0,0,0,.5);backdrop-filter:blur(10px);
            text-shadow:0 1px 3px rgba(0,0,0,0.9);
        }
        .stat-chip .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
        .dot-red{background:#ff4d4f;box-shadow:0 0 8px rgba(255,77,79,0.6)}
        .dot-gray{background:#999;box-shadow:0 0 8px rgba(153,153,153,0.6)}

        .timer-panel{
            margin:14px auto 10px;display:flex;flex-direction:column;align-items:center;gap:12px;
        }
        .timer-display{
            font-family:var(--font-serif);
            font-weight:900;letter-spacing:.06em;
            font-size:clamp(1.8rem,7vw,3.2rem);
            color:#f4e4b8;text-shadow:0 3px 10px rgba(212,175,55,0.45);
        }
        .controls{
            display:flex;gap:10px;flex-wrap:wrap;justify-content:center
        }
        .control-btn{
            padding:10px 14px;border:2px solid var(--border-gold);border-radius:8px;
            background:rgba(212,175,55,.12);color:var(--text-gold);
            font-weight:800;cursor:pointer;transition:var(--transition)
        }
        .control-btn:hover{background:rgba(212,175,55,.25);transform:translateY(-1px)}
        .toggle{
            display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border-gold);
            border-radius:999px;background:rgba(0,0,0,.4);color:#ddd;font-weight:700;cursor:pointer
        }

        .progress-wrap{
            width:100%;max-width:760px;margin:2px auto 0;position:relative
        }
        .progress{
            width:100%;height:10px;border-radius:999px;border:1px solid var(--border-gold);
            background:rgba(255,255,255,.06);overflow:hidden
        }
        .progress-bar{
            height:100%;width:0%;background:linear-gradient(90deg,var(--primary-gold),#f1dc94);
            box-shadow:0 0 12px rgba(212,175,55,.5);transition:width .4s ease
        }
        .progress-text{
            position:absolute;right:0;top:-22px;font-size:.85rem;color:#ccc;font-weight:700
        }

        /* æµç¨‹åŒº */
        .flow{position:relative;max-width:900px;margin:22px auto 120px;padding:10px 0 10px 0}
        .flow::before{
            content:'';position:absolute;left:30px;top:0;bottom:0;width:3px;
            background:linear-gradient(180deg,var(--primary-gold),rgba(212,175,55,.3))
        }
        .shelf{
            position:relative;display:flex;gap:16px;align-items:flex-start;
            padding:20px 20px 20px 68px;margin:18px 0;
            background:rgba(0,0,0,.5);
            border:2px solid var(--border-gold);
            border-radius:8px;
            transition:var(--transition);
            backdrop-filter:blur(10px);
        }
        .shelf:hover{
            transform:translateY(-2px);
            box-shadow:0 10px 28px rgba(212,175,55,.25);
            background:rgba(212,175,55,.08);
        }
        .shelf .status-dot{
            position:absolute;left:22px;top:22px;width:18px;height:18px;border-radius:50%;
            border:4px solid rgba(10,10,10,.98);box-shadow:0 0 0 4px rgba(212,175,55,.3);
            background:#ff4d4f;
        }
        .shelf.visited .status-dot{background:#888}
        .shelf-icon{
            width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;
            font-size:1.4rem;background:rgba(0,0,0,.5);border:2px solid rgba(255,255,255,.15);
            box-shadow:0 2px 8px rgba(0,0,0,0.5);
        }
        .shelf-main{flex:1;min-width:0}
        .shelf-title{
            font-family:var(--font-serif);
            font-size:1.25rem;font-weight:700;color:#f4e4b8;margin-bottom:8px;
            text-shadow:0 2px 4px rgba(0,0,0,0.9);letter-spacing:0.02em;
        }
        .shelf-desc{color:var(--text-secondary);font-size:1rem;font-weight:500;line-height:1.6;text-shadow:0 1px 3px rgba(0,0,0,0.9)}
        .shelf-meta{display:flex;align-items:center;gap:8px;margin-top:8px;font-size:.85rem;color:#aaa}
        .shelf-actions{display:flex;align-items:center;gap:12px;margin-top:14px;flex-wrap:wrap}
        .btn{
            padding:10px 18px;border:2px solid var(--border-gold);border-radius:6px;color:var(--text-gold);
            background:rgba(212,175,55,.12);cursor:pointer;transition:var(--transition);text-decoration:none;font-size:.95rem;font-weight:700;
            text-shadow:0 1px 3px rgba(0,0,0,0.9);
        }
        .btn:hover{background:rgba(212,175,55,.25);box-shadow:0 8px 20px rgba(212,175,55,.35);transform:translateY(-1px)}
        .btn[disabled]{opacity:.5;cursor:not-allowed}
        .badge{
            padding:6px 12px;border-radius:999px;font-size:.8rem;font-weight:700;border:2px solid rgba(255,255,255,.2);
            color:#ddd;background:rgba(0,0,0,.4);text-shadow:0 1px 2px rgba(0,0,0,0.9);
        }
        .shelf.visited{opacity:.75}

        /* åˆ†ç±»æ ‡ç­¾ */
        .category-tag{
            padding:4px 10px;border-radius:4px;font-size:.75rem;font-weight:600;
            background:rgba(212,175,55,.15);color:var(--text-gold);border:1px solid rgba(212,175,55,.3);
        }

        /* é”å®šé®ç½© */
        .session-overlay{
            position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,.9);
            display:flex;align-items:center;justify-content:center;padding:24px;text-align:center
        }
        .session-card{
            max-width:520px;border:2px solid var(--border-gold);border-radius:12px;padding:28px;background:rgba(20,20,20,.7);
            backdrop-filter:blur(16px);box-shadow:0 10px 24px rgba(212,175,55,.2)
        }
        .session-title{
            font-family:var(--font-serif);font-weight:900;font-size:1.6rem;margin-bottom:8px;color:#f4e4b8
        }
        .session-desc{color:#ddd;opacity:.9}
        .session-actions{margin-top:18px;display:flex;gap:12px;justify-content:center}

        .spacer{height:40px}
        @media(max-width:768px){
            .flow::before{left:20px}
            .shelf{padding-left:60px;padding:18px 16px 18px 60px}
            .shelf .status-dot{left:12px}
            .shelf-title{font-size:1.15rem}
            .shelf-desc{font-size:.95rem}
            .back-button{top:60px;left:16px;padding:10px 16px;font-size:.85rem}
        }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader">
            <div class="spinner"></div>
            <div class="loading-text">åŠ è½½é…ç½®ä¸­...</div>
        </div>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div class="error-message" id="errorMessage">
        <div class="error-icon">âš ï¸</div>
        <div class="error-title">åŠ è½½å¤±è´¥</div>
        <div class="error-desc" id="errorDesc">æ— æ³•åŠ è½½é…ç½®æ–‡ä»¶,è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜</div>
        <button class="error-btn" onclick="location.reload()">é‡æ–°åŠ è½½</button>
    </div>

    <!-- é”å®šé®ç½©ï¼ˆå®Œæˆåå½“å¤©ä¸å†åˆ·ï¼‰ -->
    <div class="session-overlay hidden" id="sessionOverlay" aria-modal="true" role="dialog">
        <div class="session-card">
            <div class="session-title">ä»Šæ—¥30åˆ†é’Ÿå·²å®Œæˆ âœ…</div>
            <div class="session-desc">å»ºè®®å…³é—­æ­¤é¡µï¼Œå®‰å¿ƒæŠ•å…¥ä¸€å¤©æ·±åº¦å·¥ä½œã€‚æ˜æ—©å†æ¥ã€‚</div>
            <div class="session-actions">
                <button class="control-btn" id="overlayConfirm">æˆ‘çŸ¥é“äº†</button>
                <button class="control-btn" id="overlayStay">ä»è¦åœç•™ï¼ˆä¸å†æ‰“å¼€æ–°æ¥æºï¼‰</button>
            </div>
        </div>
    </div>

    <!-- èƒŒæ™¯å›¾ç‰‡ -->
    <div class="hero-background"></div>

    <!-- é¡¶éƒ¨å£°æ˜ -->
    <div class="top-notice" id="topNotice">
        <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:center;gap:12px">
            <span style="color:var(--text-gold);font-weight:700" id="noticeText">âš ï¸ æ¯æ—¥æµç¨‹é¡µ Â· Beta å†…æµ‹ä¸­</span>
            <button id="noticeClose" class="notice-close" aria-label="å…³é—­">Ã—</button>
        </div>
    </div>

    <!-- è¿”å›æŒ‰é’® -->
    <a href="#" id="secureBack" class="back-button" title="è¿”å›ä¸Šä¸€é¡µ">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span>è¿”å›</span>
    </a>

    <div class="main-wrapper">
        <div class="container">
            <header class="page-header">
                <h1 class="page-title">æ¯æ—¥ä¿¡æ¯æ‘„å…¥æµç¨‹</h1>
                <p class="page-subtitle" id="pageSubtitle">30åˆ†é’Ÿçœ‹å®Œæ˜¨æ—¥ä¼˜è´¨ä¿¡æ¯æº Â· ç„¶åå®‰å¿ƒå·¥ä½œä¸€æ•´å¤©</p>

                <!-- ç»Ÿè®¡æ¡ -->
                <div class="intake-stats" aria-live="polite">
                    <span class="stat-chip"><span class="dot dot-red"></span> æœªçœ‹</span>
                    <span class="stat-chip"><span class="dot dot-gray"></span> å·²çœ‹</span>
                    <span class="stat-chip">ä»Šæ—¥å·²çœ‹åˆ°:<strong id="seenCount">0</strong> / <span id="totalCount">0</span></span>
                    <span class="stat-chip">ä¸Šæ¬¡å…¨çœ‹å®Œ:<span id="lastComplete">â€”</span></span>
                </div>

                <!-- è®¡æ—¶å™¨ä¸æ§ä»¶ -->
                <div class="timer-panel" role="region" aria-label="ä¸“æ³¨è®¡æ—¶">
                    <div class="timer-display" id="timerDisplay">30:00</div>
                    <div class="controls">
                        <button class="control-btn" id="startBtn" title="å¼€å§‹(ç©ºæ ¼)">å¼€å§‹</button>
                        <button class="control-btn" id="pauseBtn" title="æš‚åœ(ç©ºæ ¼)">æš‚åœ</button>
                        <button class="control-btn" id="resetBtn" title="é‡ç½®(R)">é‡ç½®</button>
                        <button class="toggle" id="focusToggle" title="ä»…æ˜¾ç¤ºä¸‹ä¸€æ¡ï¼Œå‡å°‘å†³ç­–">ä¸“æ³¨æ¨¡å¼ï¼šå…³é—­</button>
                        <button class="toggle" id="unseenToggle" title="åªæ˜¾ç¤ºæœªçœ‹æ¥æº">ä»…çœ‹æœªçœ‹ï¼šå…³é—­</button>
                        <button class="control-btn" id="nextBtn" title="æ‰“å¼€ä¸‹ä¸€æ¡(N)">ä¸‹ä¸€æ¡</button>
                    </div>
                    <div class="progress-wrap">
                        <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </div>
            </header>

            <!-- æµç¨‹åŒº -->
            <section class="flow" id="flow"></section>
            <div class="spacer"></div>
        </div>
    </div>

    <script>
        (function(){
            'use strict';

            // ====== é…ç½®æ–‡ä»¶è·¯å¾„ ======
            const CONFIG_PATH = './daily-intake-config.json';
            let APP_CONFIG = null;
            let SOURCES = [];

            // ====== ä¼šè¯ä¸çŠ¶æ€é”® ======
            const todayStr = new Date().toLocaleDateString('sv-SE'); // YYYY-MM-DD
            const VISITED_KEY = `intake-visited:${todayStr}`;
            const LAST_COMPLETE_KEY = 'intake-last-complete-at';
            const SESSION_KEY = `intake-session:${todayStr}`;

            // ====== å¯å˜çŠ¶æ€ ======
            let visited = new Set();
            let focusMode = false;       // ä¸“æ³¨æ¨¡å¼ï¼šä»…æ˜¾ç¤ºä¸‹ä¸€æ¡æœªçœ‹
            let onlyUnseen = false;      // ä»…çœ‹æœªçœ‹è¿‡æ»¤
            let lockedToday = false;     // ä»Šæ—¥æ˜¯å¦é”å®šï¼ˆè®¡æ—¶ç»“æŸï¼‰
            let timerSeconds = 0;        // å‰©ä½™ç§’
            let timerRunning = false;
            let timerHandle = null;

            // ====== åˆå§‹åŒ– ======
            async function init(){
                try {
                    const response = await fetch(CONFIG_PATH);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    APP_CONFIG = await response.json();

                    if (!APP_CONFIG.settings || !APP_CONFIG.sources) {
                        throw new Error('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯');
                    }

                    SOURCES = APP_CONFIG.sources
                        .filter(s => s.enabled !== false)
                        .sort((a, b) => (a.priority || 999) - (b.priority || 999));

                    if (SOURCES.length === 0) {
                        throw new Error('æ²¡æœ‰å¯ç”¨çš„ä¿¡æ¯æº');
                    }

                    applyConfig();

                    // åŠ è½½æœ¬åœ°çŠ¶æ€
                    visited = getVisitedSet();
                    loadSessionState(APP_CONFIG.settings);

                    // éšè—åŠ è½½åŠ¨ç”»
                    document.getElementById('loadingOverlay').classList.add('hidden');

                    // åˆå§‹åŒ–åº”ç”¨
                    initApp();
                } catch (error) {
                    console.error('é…ç½®åŠ è½½å¤±è´¥:', error);
                    showError(error.message);
                }
            }

            function showError(message){
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('errorDesc').textContent = message;
                document.getElementById('errorMessage').classList.add('show');
            }

            function applyConfig(){
                const settings = APP_CONFIG.settings;
                if (settings.noticeText) {
                    document.getElementById('noticeText').textContent = settings.noticeText;
                }
                if (settings.dailyTimeLimit) {
                    const subtitle = `${settings.dailyTimeLimit}åˆ†é’Ÿçœ‹å®Œæ˜¨æ—¥ä¼˜è´¨ä¿¡æ¯æº Â· ç„¶åå®‰å¿ƒå·¥ä½œä¸€æ•´å¤©`;
                    document.getElementById('pageSubtitle').textContent = subtitle;
                }
            }

            // ====== å­˜å‚¨ä¸æ—¶é—´æ ¼å¼ ======
            function getVisitedSet(){
                try {
                    const raw = localStorage.getItem(VISITED_KEY);
                    const arr = raw ? JSON.parse(raw) : [];
                    return new Set(Array.isArray(arr) ? arr : []);
                } catch { return new Set(); }
            }
            function saveVisitedSet(set){
                localStorage.setItem(VISITED_KEY, JSON.stringify(Array.from(set)));
            }
            function setLastComplete(nowISO){
                localStorage.setItem(LAST_COMPLETE_KEY, nowISO);
            }
            function getLastComplete(){
                return localStorage.getItem(LAST_COMPLETE_KEY) || '';
            }
            function formatTime(iso){
                if (!iso) return 'â€”';
                try {
                    const d = new Date(iso);
                    const pad = n => String(n).padStart(2,'0');
                    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
                } catch { return 'â€”'; }
            }

            // ====== è®¡æ—¶å™¨/ä¼šè¯çŠ¶æ€ ======
            function loadSessionState(settings){
                const defaultSeconds = Math.max(1, (settings.dailyTimeLimit || 30)) * 60;
                const raw = localStorage.getItem(SESSION_KEY);
                if (raw){
                    try{
                        const s = JSON.parse(raw);
                        lockedToday = !!s.locked;
                        focusMode = !!s.focusMode;
                        onlyUnseen = !!s.onlyUnseen;
                        timerSeconds = Number.isFinite(s.timerSeconds) ? s.timerSeconds : defaultSeconds;
                        timerRunning = !!s.timerRunning;
                    }catch{
                        timerSeconds = defaultSeconds;
                    }
                }else{
                    timerSeconds = defaultSeconds;
                }
            }
            function saveSessionState(){
                localStorage.setItem(SESSION_KEY, JSON.stringify({
                    locked: lockedToday,
                    focusMode,
                    onlyUnseen,
                    timerSeconds,
                    timerRunning
                }));
            }
            function formatMMSS(sec){
                const s = Math.max(0, Math.floor(sec));
                const mm = String(Math.floor(s/60)).padStart(2,'0');
                const ss = String(s%60).padStart(2,'0');
                return `${mm}:${ss}`;
            }
            function startTimer(){
                if (lockedToday) return;
                if (timerRunning) return;
                timerRunning = true;
                tick();
                timerHandle = setInterval(tick, 1000);
                refreshTimerUI();
                saveSessionState();
            }
            function pauseTimer(){
                if (!timerRunning) return;
                timerRunning = false;
                if (timerHandle) clearInterval(timerHandle);
                timerHandle = null;
                refreshTimerUI();
                saveSessionState();
            }
            function resetTimer(){
                const settings = APP_CONFIG.settings;
                const defaultSeconds = Math.max(1, (settings.dailyTimeLimit || 30)) * 60;
                timerSeconds = defaultSeconds;
                pauseTimer();
                refreshTimerUI();
                saveSessionState();
            }
            function tick(){
                if (!timerRunning) return;
                timerSeconds -= 1;
                if (timerSeconds <= 0){
                    timerSeconds = 0;
                    pauseTimer();
                    // é”å®šä»Šæ—¥
                    lockedToday = true;
                    saveSessionState();
                    showLockOverlay();
                }
                refreshTimerUI();
                saveSessionState();
            }

            // ====== åº”ç”¨ä¸»é€»è¾‘ ======
            function initApp(){
                // é¡¶éƒ¨å…¬å‘Š
                const topNotice = document.getElementById('topNotice');
                const noticeClose = document.getElementById('noticeClose');
                if (topNotice && noticeClose) {
                    if (sessionStorage.getItem('intakeNoticeClosed') === 'true') {
                        topNotice.style.display = 'none';
                        document.querySelector('.main-wrapper').style.paddingTop = '48px';
                    }
                    const closeNotice = () => {
                        sessionStorage.setItem('intakeNoticeClosed', 'true');
                        topNotice.style.display = 'none';
                        document.querySelector('.main-wrapper').style.paddingTop = '48px';
                    };
                    noticeClose.addEventListener('click', closeNotice);
                    if (APP_CONFIG.settings.noticeAutoCloseDelay) {
                        setTimeout(closeNotice, APP_CONFIG.settings.noticeAutoCloseDelay);
                    }
                }

                // è¿”å›æŒ‰é’®
                const backBtn = document.getElementById('secureBack');
                if (backBtn) {
                    backBtn.addEventListener('click', function(e){
                        e.preventDefault();
                        const code = prompt('è¯·è¾“å…¥å®‰å…¨ç ä»¥è¿”å›:');
                        if (code === null) return;
                        if (code === APP_CONFIG.settings.securityCode) {
                            if (APP_CONFIG.settings.returnUrl && APP_CONFIG.settings.returnUrl.trim().length > 0) {
                                window.location.href = APP_CONFIG.settings.returnUrl;
                            } else {
                                alert('å·²é€šè¿‡æ ¡éªŒ,ä½†æœªè®¾ç½®è¿”å›é“¾æ¥ã€‚');
                            }
                        } else {
                            alert('å®‰å…¨ç é”™è¯¯,æ— æ³•è¿”å›ã€‚');
                        }
                    });
                }

                // UIå…ƒç´ 
                const flowEl = document.getElementById('flow');
                const seenCountEl = document.getElementById('seenCount');
                const totalCountEl = document.getElementById('totalCount');
                const lastCompleteEl = document.getElementById('lastComplete');
                const timerDisplay = document.getElementById('timerDisplay');
                const startBtn = document.getElementById('startBtn');
                const pauseBtn = document.getElementById('pauseBtn');
                const resetBtn = document.getElementById('resetBtn');
                const focusToggle = document.getElementById('focusToggle');
                const unseenToggle = document.getElementById('unseenToggle');
                const nextBtn = document.getElementById('nextBtn');
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');

                totalCountEl.textContent = String(SOURCES.length);
                lastCompleteEl.textContent = formatTime(getLastComplete());

                // æ§ä»¶äº‹ä»¶
                startBtn.addEventListener('click', startTimer);
                pauseBtn.addEventListener('click', pauseTimer);
                resetBtn.addEventListener('click', () => {
                    const ok = confirm('é‡ç½®è®¡æ—¶å™¨åˆ°åˆå§‹æ—¶é•¿ï¼Ÿ');
                    if (ok) resetTimer();
                });
                focusToggle.addEventListener('click', () => {
                    focusMode = !focusMode;
                    focusToggle.textContent = `ä¸“æ³¨æ¨¡å¼ï¼š${focusMode ? 'å¼€å¯' : 'å…³é—­'}`;
                    saveSessionState();
                    render();
                });
                unseenToggle.addEventListener('click', () => {
                    onlyUnseen = !onlyUnseen;
                    unseenToggle.textContent = `ä»…çœ‹æœªçœ‹ï¼š${onlyUnseen ? 'å¼€å¯' : 'å…³é—­'}`;
                    saveSessionState();
                    render();
                });
                nextBtn.addEventListener('click', openNextUnseen);

                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
                    if (e.code === 'Space'){
                        e.preventDefault();
                        timerRunning ? pauseTimer() : startTimer();
                    }else if (e.key.toLowerCase() === 'n'){
                        e.preventDefault();
                        openNextUnseen();
                    }else if (e.key.toLowerCase() === 'r'){
                        e.preventDefault();
                        resetTimer();
                    }
                });

                // åˆå§‹UI
                refreshTimerUI();
                render();

                // è‹¥å·²é”å®šï¼Œæ˜¾ç¤ºé®ç½©
                if (lockedToday){
                    showLockOverlay(false);
                }

                // å†…éƒ¨å‡½æ•°
                function render(){
                    flowEl.innerHTML = '';

                    // è¿‡æ»¤/æ’åº
                    let list = SOURCES.slice();
                    if (onlyUnseen) list = list.filter(s => !visited.has(s.id));

                    // ä¸“æ³¨æ¨¡å¼ï¼šä»…æ˜¾ç¤ºä¸‹ä¸€æ¡
                    if (focusMode){
                        const next = SOURCES.find(s => !visited.has(s.id));
                        list = next ? [next] : [];
                    }

                    list.forEach((s) => {
                        const shelf = document.createElement('div');
                        shelf.className = 'shelf';
                        shelf.dataset.id = s.id;
                        if (visited.has(s.id)) shelf.classList.add('visited');

                        const status = document.createElement('span');
                        status.className = 'status-dot';
                        shelf.appendChild(status);

                        const icon = document.createElement('div');
                        icon.className = 'shelf-icon';
                        icon.textContent = s.icon || 'ğŸ“š';

                        const main = document.createElement('div');
                        main.className = 'shelf-main';

                        const title = document.createElement('div');
                        title.className = 'shelf-title';
                        title.textContent = s.name;

                        const desc = document.createElement('div');
                        desc.className = 'shelf-desc';
                        desc.textContent = s.desc || '';

                        if (s.category) {
                            const meta = document.createElement('div');
                            meta.className = 'shelf-meta';
                            const catTag = document.createElement('span');
                            catTag.className = 'category-tag';
                            catTag.textContent = s.category;
                            meta.appendChild(catTag);
                            main.appendChild(title);
                            main.appendChild(desc);
                            main.appendChild(meta);
                        } else {
                            main.appendChild(title);
                            main.appendChild(desc);
                        }

                        const actions = document.createElement('div');
                        actions.className = 'shelf-actions';

                        const goBtn = document.createElement('button');
                        goBtn.className = 'btn';
                        goBtn.textContent = 'å»æŸ¥çœ‹';
                        goBtn.setAttribute('aria-label', `æ‰“å¼€:${s.name}`);
                        if (lockedToday) goBtn.disabled = true;
                        goBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (lockedToday) { showLockOverlay(); return; }
                            markVisitedAndOpen(s.id, s.url);
                        });

                        const stateBadge = document.createElement('span');
                        stateBadge.className = 'badge';
                        stateBadge.textContent = visited.has(s.id) ? 'å·²çœ‹' : 'æœªçœ‹';

                        actions.appendChild(goBtn);
                        actions.appendChild(stateBadge);
                        main.appendChild(actions);

                        shelf.appendChild(icon);
                        shelf.appendChild(main);

                        shelf.addEventListener('click', () => {
                            if (lockedToday) { showLockOverlay(); return; }
                            markVisitedAndOpen(s.id, s.url);
                        });

                        flowEl.appendChild(shelf);
                    });

                    // è®¡æ•°ä¸è¿›åº¦
                    updateCounts();
                }

                function openNextUnseen(){
                    if (lockedToday) { showLockOverlay(); return; }
                    const next = SOURCES.find(s => !visited.has(s.id));
                    if (!next){
                        alert('ä»Šæ—¥å…¨éƒ¨å·²çœ‹å®Œï¼Œåšå¾—å¥½ï¼');
                        return;
                    }
                    markVisitedAndOpen(next.id, next.url);
                }

                function markVisitedAndOpen(id, url){
                    if (!visited.has(id)) {
                        visited.add(id);
                        saveVisitedSet(visited);
                        const shelf = document.querySelector(`[data-id="${id}"]`);
                        if (shelf) {
                            shelf.classList.add('visited');
                            const badge = shelf.querySelector('.badge');
                            if (badge) badge.textContent = 'å·²çœ‹';
                        }
                        updateCounts(true);
                    }
                    try {
                        window.open(url, '_blank', 'noopener');
                    } catch {
                        location.href = url;
                    }
                }

                function updateCounts(checkComplete=false){
                    seenCountEl.textContent = String(visited.size);
                    totalCountEl.textContent = String(SOURCES.length);

                    const ratio = SOURCES.length ? visited.size / SOURCES.length : 0;
                    progressBar.style.width = `${Math.round(ratio*100)}%`;
                    progressText.textContent = `${Math.round(ratio*100)}%`;

                    if (checkComplete && visited.size === SOURCES.length) {
                        const nowISO = new Date().toISOString();
                        setLastComplete(nowISO);
                        lastCompleteEl.textContent = formatTime(nowISO);
                    }
                }

                function refreshTimerUI(){
                    timerDisplay.textContent = formatMMSS(timerSeconds);
                    // æ§ä»¶çŠ¶æ€
                    document.getElementById('startBtn').disabled = lockedToday || timerRunning || timerSeconds <= 0;
                    document.getElementById('pauseBtn').disabled = lockedToday || !timerRunning;
                    document.getElementById('resetBtn').disabled = lockedToday;
                    document.getElementById('nextBtn').disabled = lockedToday;
                    document.getElementById('focusToggle').textContent = `ä¸“æ³¨æ¨¡å¼ï¼š${focusMode ? 'å¼€å¯' : 'å…³é—­'}`;
                    document.getElementById('unseenToggle').textContent = `ä»…çœ‹æœªçœ‹ï¼š${onlyUnseen ? 'å¼€å¯' : 'å…³é—­'}`;
                }
            }

            function showLockOverlay(autoFocus=true){
                const overlay = document.getElementById('sessionOverlay');
                overlay.classList.remove('hidden');

                const stay = document.getElementById('overlayStay');
                const ok = document.getElementById('overlayConfirm');

                ok.onclick = () => {
                    overlay.classList.add('hidden');
                    // è¿”å›é¡µæˆ–å…³é—­æ ‡ç­¾é¡µç”±ç”¨æˆ·è‡ªè¡Œå†³å®š
                };
                stay.onclick = () => {
                    overlay.classList.add('hidden');
                    // ä¿æŒé”å®šï¼Œä¸å…è®¸æ‰“å¼€æ–°æ¥æº
                };
                if (autoFocus) ok.focus();
            }

            // é¡µé¢åŠ è½½ååˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>
